STAPPLER_ROOT ?= ../..

LOCAL_OUTDIR := lib
LOCAL_OUTPUT_LIBRARY := $(LOCAL_OUTDIR)/Handlers.so

LOCAL_TOOLKIT := serenity

LOCAL_ROOT = .

LOCAL_SRCS_DIRS :=  srcs
LOCAL_SRCS_OBJS :=

LOCAL_INCLUDES_DIRS := srcs
LOCAL_INCLUDES_OBJS :=

verbose:= 1

LOCAL_CFLAGS =  -ftemplate-backtrace-limit=0

CONF_DIR:= $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

CONF_SERVER_PORT?= 8080
CONF_DB?= host=localhost dbname=test user=serenity password=serenity

$(LOCAL_OUTDIR)/httpd.conf: Makefile
	@mkdir -p $(LOCAL_OUTDIR)
	@echo '# Autogenerated by makefile\n' > $@
	@echo 'LoadModule serenity_module $(abspath $(SERENITY_OUTPUT))' >> $@
	@echo 'ServerAdmin serenity@stappler.org' >> $@
	@echo 'ServerName localhost' >> $@
	@echo 'Listen $(CONF_SERVER_PORT)\n' >> $@
	@echo 'DBDriver pgsql' >> $@
	@echo 'DBDPersist On' >> $@
	@echo 'DBDParams "$(CONF_DB)"\n' >> $@
	@echo 'SerenitySourceRoot "$(CONF_DIR)lib"' >> $@
	@echo '<Directory "$(CONF_DIR)www">' >> $@
	@echo '\tRequire all granted' >> $@
	@echo '</Directory>\n' >> $@
	@echo '<Location "/uploads/*>' >> $@
	@echo '\tRequire all denied' >> $@
	@echo '</Location>\n' >> $@
	@echo 'DocumentRoot "$(CONF_DIR)www"' >> $@
	@echo 'ErrorLog "$(CONF_DIR)lib/serenity.error.log"' >> $@
	@echo 'CustomLog "$(CONF_DIR)lib/serenity.access.log" common\n' >> $@
	@echo 'SerenitySource "Test:$(notdir $(LOCAL_OUTPUT_LIBRARY)):CreateTestHandler"' >> $@
	@echo 'SerenitySession name=SID key=SPSession maxage=0 secure=true' >> $@

.local_prebuild: $(LOCAL_OUTDIR)/httpd.conf

.local_preclean:
	rm -f $(LOCAL_OUTDIR)/test.conf

include $(STAPPLER_ROOT)/make/local.mk
