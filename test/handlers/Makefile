STAPPLER_ROOT ?= ../..

LOCAL_OUTDIR := lib
LOCAL_LIBRARY := Lib

LOCAL_TOOLKIT := serenity
LOCAL_INSTALL_DIR := $(LOCAL_OUTDIR)

LOCAL_ROOT = .

LOCAL_SRCS_DIRS :=  srcs
LOCAL_SRCS_OBJS :=

LOCAL_INCLUDES_DIRS := srcs
LOCAL_INCLUDES_OBJS :=

LOCAL_CFLAGS =  -ftemplate-backtrace-limit=0
LOCAL_OPTIMIZATION := -g -O2
LOCAL_FORCE_INSTALL := 1

CONF_PREFIX ?=
CONF ?= local
CONF_DIR:= $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

ifeq ($(CONF),docker)
CONF_PREFIX:= gen-
SERENITY_DOCKER_CTRL_CONFIG := $(abspath $(CONF_DIR)conf/serenity-docker.conf)
SERENITY_DOCKER_CTRL_HTTPD_CONF := $(abspath $(CONF_DIR)lib/httpd.conf)
endif


include $(STAPPLER_ROOT)/make/local.mk

export SERENITY_DEFAULT_CONFIG
$(LOCAL_OUTDIR)/httpd.conf: Makefile
	@mkdir -p $(LOCAL_OUTDIR)
	@mkdir -p $(CONF_DIR)logs
	@echo '# Autogenerated by makefile\n' > $@
	@echo "$$SERENITY_DEFAULT_CONFIG" >> $@
	@echo 'ServerRoot "$(CONF_DIR)"' >> $@
	@echo 'ErrorLog "$(CONF_DIR)logs/error_log"' >> $@
	@echo 'CustomLog "$(CONF_DIR)logs/access_log" common' >> $@
	@echo 'SerenitySourceRoot "$(CONF_DIR)lib"' >> $@
	@echo 'Include $(CONF_DIR)conf/$(CONF_PREFIX)serenity-$(CONF).conf' >> $@
	@echo 'IncludeOptional $(CONF_DIR)conf/sites-$(CONF)/*.conf' >> $@

export SERENITY_DOCKER_CTRL
$(LOCAL_OUTDIR)/ctrl.sh: Makefile
	@mkdir -p $(LOCAL_OUTDIR)
	@echo "$$SERENITY_DOCKER_CTRL" > $@
	@chmod +x $@

all: $(LOCAL_OUTDIR)/httpd.conf $(LOCAL_OUTDIR)/ctrl.sh
